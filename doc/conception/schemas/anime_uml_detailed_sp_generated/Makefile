include Config.mk

# Generic code

MODEL_FILE=$(MODEL_PATH)/$(MODEL).$(MODEL_EXT)

# Query model for active objects and interaction names
ELEMENTS:=$(shell node au2pu.js $(MODEL_FILE) model $(MODEL) listActive=true listInteractions=true listClasses=true listEnumerations=true | sed -ne 's/ /_/g;/^ACTIVE_OBJECTS:$$/,$$p')
#OBJECTS:=$(shell echo "$(ELEMENTS)" | sed -e 's/ /\n/g' | sed -ne '/^ACTIVE_OBJECTS:$$/,/^END$$/p' | tail -n +2 | ghead -n -1)
INTERACTIONS:=$(shell echo "$(ELEMENTS)" | sed -e 's/ /\n/g' | sed -ne '/^INTERACTIONS:$$/,/^END$$/p' | tail -n +2 | ghead -n -1)
CLASSES:=$(shell echo "$(ELEMENTS)" | sed -e 's/ /\n/g' | sed -ne '/^CLASSES:$$/,/^END$$/p' | tail -n +2 | ghead -n -1)
#ENUMERATIONS:=$(shell echo "$(ELEMENTS)" | sed -e 's/ /\n/g' | sed -ne '/^ENUMERATIONS:$$/,/^END$$/p' | tail -n +2 | ghead -n -1)

# List of diagrams automatically generated by au2pu.js that we will use
#AUTO_PUML=$(MODEL)-context.pdf $(MODEL)-classes.pdf $(MODEL)-datatypes.pdf $(addprefix $(MODEL)-,$(OBJECTS:=-SM.pdf))
AUTO_PUML+=$(addprefix $(MODEL)-class-,$(CLASSES:=.pdf))
AUTO_PUML+=$(addprefix $(MODEL)-class-,$(CLASSES:=.pdf))
AUTO_PUML+=$(addsuffix -SM.pdf,$(addprefix $(MODEL)-,$(shell echo $(FOLDED_STATES) | sed -re "s/,/ /g;s/(^| )([^.]+)\./ \2-\2./g")))
AUTO_PUML+=$(addprefix $(MODEL)-activity-,$(ACTIVITIES:=.pdf))
AUTO_SVG=$(addprefix $(MODEL)-sequence-,$(INTERACTIONS:=.pdf))

# List of diagrams automatically generated by au2pu.js that we will not use
#UNUSED_PUML=$(MODEL).pdf ${MODEL}-class.pdf $(addprefix $(MODEL)-,$(OBJECTS:=.pdf))

# Special symbol definitions for later use
SPACE=$(subst ,, )
COMMA=,

# List of alldiagrams to process
DIAGRAMS=$(AUTO_PUML) $(MANU_PUML) $(AUTO_SVG)

LATEX_GEN=./generateLaTeX.sh

#Je l'ai remis mais certainement pas au bon endroit
#	@echo -e "\n================================================================================\n"
#	@echo "                               Start to generate PUML files"
#	@echo -e "\n================================================================================\n"

all: $(DIAGRAMS)

clean:
	-rm -f $(AUTO_PUML) $(AUTO_PUML:.pdf=.svg) $(AUTO_PUML:.pdf=.puml)
	-rm -f $(UNUSED_PUML) $(UNUSED_PUML:.pdf=.svg) $(UNUSED_PUML:.pdf=.puml)
	-rm -f $(patsubst %,"%",$(AUTO_SVG)) $(patsubst %,"%",$(AUTO_SVG:.pdf=.svg))
	# not removing source PlantUML files for "manual" diagrams
	-rm -f $(MANU_PUML) $(MANU_PUML:.pdf=.svg)
	-rm -f $(MODEL)-macros.tex
	-rm -f example.tex example.pdf example.aux example.fdb_latexmk example.fls example.log example.out

%-crop.pdf: %.pdf
	pdfcrop "$<"

$(MODEL)-macros.tex $(AUTO_SVG:.pdf=.svg) $(AUTO_PUML:.pdf=.puml) $(UNUSED_PUML:.pdf=.puml) &: $(MODEL_FILE)
	#node $(ANIMUML_PATH)/src/au2pu.js $< model $(MODEL) foldedStateFQNs=$(subst $(SPACE),$(COMMA),$(FOLDED_STATES)) narrow=true $(PARAMS)
	node au2pu.js $< model $(MODEL) foldedStateFQNs=$(subst $(SPACE),$(COMMA),$(FOLDED_STATES)) narrow=true rawPlantUML=true genActivitiesFor=$(subst $(SPACE),$(COMMA),$(ACTIVITIES)) $(PARAMS)

%-cleaned.svg: %.svg
	# otherwise rsvg will show PlantUML's hidden edges
	sed -re 's/(<path [^>]*)style="stroke:#00000000;[^"]*"/\1/p' "$<" > "$@"

%.pdf: %-cleaned.svg
	rsvg-convert -f pdf "$<" > "$@"

%.svg: %.puml
	plantuml -checkmetadata -tsvg "$<"
	# making sure we do not check metadata again until next change
	touch "$@"

#example.tex: $(MODEL_FILE) $(LATEX_GEN) $(MODEL)-macros.tex
#	$(LATEX_GEN) $(MODEL) "$(OBJECTS)" "$(INTERACTIONS)" "$(CLASSES)" "$(ENUMERATIONS)" "$(ACTIVITIES)"

%.pdf: %.tex $(DIAGRAMS)
	latexmk -lualatex "$<"

# keeping .svg files so that PlantUML can check their metadata, which avoids regenerating them when there is no actual change.
.PRECIOUS: %.svg

